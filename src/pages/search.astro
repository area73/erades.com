---
import Layout from "../layouts/BlogPost.astro";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Paginator from "../components/Paginator.astro";
import BlogFilters from "../components/BlogFilters.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
import BlogCard from "../components/BlogCard.astro";
import { Search } from "@lucide/astro";

const query = Astro.url.searchParams.get("q") || "";

let results = [];
if (query) {
  const { origin } = new URL(Astro.request.url);
  const apiUrl = `${origin}/api/search?q=${encodeURIComponent(query)}`;
  const res = await fetch(apiUrl);
  results = await res.json();
}
console.log("[search.astro] QUERY:", query);
console.log("[search.astro] RESULTS LENGTH:", results.length);

const pageParam = Number(Astro.url.searchParams.get("page")) || 1;
const RESULTS_PER_PAGE = 10;
// Filtrar resultados por categoría seleccionada
const categoryParam = Astro.url.searchParams.get("category") || "all";
const filteredResults =
  categoryParam === "all"
    ? results
    : results.filter((post: any) =>
        Array.isArray(post.categories)
          ? post.categories.includes(categoryParam)
          : false
      );
const totalPages = Math.ceil(filteredResults.length / RESULTS_PER_PAGE);
const currentPage = Math.max(1, Math.min(pageParam, totalPages || 1));

const sortBy = Astro.url.searchParams.get("sortBy") || "date-desc";
// Ordenar los resultados filtrados según sortBy
let sortedResults = [...filteredResults];
switch (sortBy) {
  case "date-asc":
    sortedResults.sort(
      (a: any, b: any) =>
        new Date(a.pubDate || a.data?.pubDate || 0).valueOf() -
        new Date(b.pubDate || b.data?.pubDate || 0).valueOf()
    );
    break;
  case "date-desc":
    sortedResults.sort(
      (a: any, b: any) =>
        new Date(b.pubDate || b.data?.pubDate || 0).valueOf() -
        new Date(a.pubDate || a.data?.pubDate || 0).valueOf()
    );
    break;
  case "title":
    sortedResults.sort((a: any, b: any) =>
      (a.title || a.data?.title || "").localeCompare(
        b.title || b.data?.title || ""
      )
    );
    break;
}

const paginatedResults = sortedResults.slice(
  (currentPage - 1) * RESULTS_PER_PAGE,
  currentPage * RESULTS_PER_PAGE
);

const categories = [
  ...Array.from(
    new Set(
      results
        .flatMap((r: any) => (Array.isArray(r.categories) ? r.categories : []))
        .filter(Boolean)
    )
  ),
] as string[];
if (!categories.includes("all")) categories.unshift("all");
---

<Layout
  title={`Search | ${SITE_TITLE}`}
  description={SITE_DESCRIPTION}
  tags={[]}
  categories={[]}
  draft={false}
>
  <section>
    <div class="max-w-[1200px] mx-auto pt-8 transition-main">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-foreground mb-2">
          Resultados de búsqueda
        </h1>
        {
          query && (
            <p class="text-muted-foreground">
              Mostrando {paginatedResults.length} de {filteredResults.length}{" "}
              resultados para "{query}"
            </p>
          )
        }
      </div>
      <BlogFilters
        categories={categories}
        selectedCategory={categoryParam}
        sortBy={sortBy}
        viewMode={"grid"}
        getCategoryHref={(cat: string) =>
          `?q=${encodeURIComponent(query)}&category=${encodeURIComponent(cat)}`}
      />
      <div class="max-w-5xl mx-auto px-4 py-8">
        <ul class="grid grid-cols-1 md:grid-cols-2 gap-8 list-none m-0 p-0">
          {
            paginatedResults.length === 0 && query ? (
              <li class="col-span-full text-center py-12">
                <Search class="mx-auto mb-4 text-muted-foreground h-12 w-12 stroke-2" />
                <h3 class="font-serif text-xl font-semibold text-foreground mb-2">
                  No se encontraron resultados
                </h3>
                <p class="text-muted-foreground mb-6">
                  Intenta con otros términos de búsqueda o cambia los filtros.
                </p>
                <a
                  href="?category=all"
                  class="px-4 py-2 rounded-md border border-border bg-muted text-muted-foreground hover:bg-primary/10 transition"
                >
                  Ver todos los posts
                </a>
              </li>
            ) : (
              paginatedResults.map((doc: any) => {
                const post = doc.data ? doc : { data: doc };
                return (
                  <li>
                    <BlogCard post={post} variant="grid" />
                  </li>
                );
              })
            )
          }
        </ul>
        {
          totalPages > 1 && (
            <Paginator
              currentPage={currentPage}
              totalPages={totalPages}
              getPageHref={(page) =>
                `?q=${encodeURIComponent(query)}&category=${encodeURIComponent(categoryParam)}&sortBy=${encodeURIComponent(sortBy)}&page=${page}`
              }
            />
          )
        }
      </div>
    </div>
  </section></Layout
>
